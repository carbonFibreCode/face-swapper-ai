// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  credits        Int       @default(10)
  assets         Asset[]
  generations    Generation[]
  plan           SubscriptionPlan @default(FREE)
  stripeCustomerId String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[]
  accounts      Account[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Asset {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String   @default("Untitled Asset")
  url         String   // S3/R2 URL
  thumbnailUrl String? // Separate thumbnail URL for videos
  type        AssetType // IMAGE (Face) or VIDEO (Source)
  
  // File metadata
  size        Int      @default(0) // File size in bytes
  width       Int?
  height      Int?
  duration    Float?   // Video duration in seconds
  
  createdAt   DateTime @default(now())
  
  generations Generation[] // Track which assets were used where
  
  @@index([userId])
}

model Template {
  id          String   @id @default(cuid())
  
  thumbnailUrl String
  videoUrl     String
  
  // UX: Tags for filtering (e.g. "Funny", "Movie Scene")
  tags         String[] 
  duration     Float    // In seconds (to estimate cost)
  
  // Visibility control (e.g. disable a buggy template without deleting it)
  isActive     Boolean  @default(true)
  
  createdAt    DateTime @default(now())
  generations  Generation[]
}

model Generation {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Inputs
  templateId   String?  // Optional: User might upload their OWN video eventually
  template     Template? @relation(fields: [templateId], references: [id])
  
  assetId      String   // The Face used
  asset        Asset    @relation(fields: [assetId], references: [id])
  
  // AI Status State Machine
  status       JobStatus @default(QUEUED)
  failureReason String?  // Store error msg from Replicate if it fails
  
  // Cost Tracking (Audit trail)
  cost         Int      @default(1)
  
  // Provider Metadata (Crucial for Webhooks)
  providerJobId String? @unique // The ID returned by Replicate/Fal.ai
  resultUrl     String? // The final video
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt // Track how long generation took

  @@index([userId])
  @@index([providerJobId]) // Faster webhook lookups
}

enum SubscriptionPlan {
  FREE
  PRO
}

enum AssetType {
  IMAGE
  VIDEO
}

enum JobStatus {
  QUEUED     
  COMPLETED 
  FAILED     
}
